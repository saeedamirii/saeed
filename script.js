/* فایل: script.js (نسخه نهایی و صحیح) */

document.addEventListener('DOMContentLoaded', () => {

    // =========================================================
    // ### بانک لغات عظیم، نهایی و باکیفیت ###
    // =========================================================
    const WORD_BANK = {
        4: ["آباد", "آتش", "آخر", "آرام", "آرزو", "آزاد", "آسیب", "آچار", "آگهی", "آینه", "ابرو", "اجاق", "ادب", "ادعا", "اذان", "ارده", "اسب", "اسم", "اشک", "اصل", "اعدا", "اغلب", "امید", "انتها", "انشا", "ایده", "ایست", "ایمن", "بابا", "باطن", "باور", "ببر", "بچه", "برج", "برق", "برگ", "بغل", "بلند", "بمب", "بنا", "بنز", "بند", "بوق", "بوم", "بیان", "بید", "بیمه", "پارو", "پاسخ", "پاک", "پتو", "پدر", "پسر", "پشه", "پشم", "پمپ", "پنبه", "پهن", "پیاز", "پیک", "پیل", "تاب", "تاج", "تار", "تازه", "تخت", "تخم", "ترس", "ترک", "ترمز", "تست", "تلفن", "تمبر", "تنبل", "تنگ", "توپ", "تپه", "تیر", "تیز", "تیغ", "ثبت", "جاده", "جارو", "جشن", "جعبه", "جفت", "جنگ", "جواب", "جوجه", "جوش", "چادر", "چاقو", "چاه", "چپ", "چتر", "چرب", "چرخ", "چرم", "چسب", "چشم", "چکش", "حجم", "حرف", "حسود", "حنا", "حوض", "حوله", "خار", "خاک", "خال", "خامه", "خبر", "خرج", "خرس", "خشک", "خط", "خلق", "خواب", "خوب", "خون", "خیار", "خیس", "خیمه", "داد", "دارو", "دبی", "درب", "درد", "درس", "درشت", "دره", "دریا", "دزد", "دست", "دسر", "دعا", "دفتر", "دقت", "دکل", "دکمه", "دل", "دلار", "دنده", "دنیا", "دوغ", "دوش", "ذره", "ذوب", "رانت", "راه", "رخت", "رشد", "رعد", "رنگ", "روغن", "ریال", "ریسمان", "ریش", "ریه", "زاد", "زانو", "زبان", "زبر", "زخم", "زرد", "زرشک", "زعفران", "زشت", "زمان", "زمین", "زنبور", "زنگ", "زود", "زور", "زیتون", "زین", "ژاپن", "ژله", "ژاکت", "ساد", "ساده", "ساز", "ساق", "ساقه", "سال", "سالم", "سامان", "سایه", "سبد", "سبز", "سبزی", "سحر", "سر", "سرد", "سرفه", "سوسک", "سوزن", "سکه", "سگ", "سنگ", "سهم", "سیاه", "سیب", "سیر", "سیل", "سیم", "سینی", "شادی", "شال", "شام", "شانه", "شاه", "شب", "شتاب", "شتر", "شربت", "شرط", "شروع", "شست", "شعر", "شغل", "شکل", "شمال", "شمع", "شنا", "شن", "شور", "شوک", "شهاب", "شهر", "شومینه", "شیر", "شیشه", "شیطان", "شیب", "شیپور", "صبر", "صبح", "صدا", "صدف", "صف", "صفحه", "صمغ", "صندل", "صابون", "ضامن", "ضرب", "ضعف", "ضرر", "ضلع", "طبل", "طرح", "طعم", "طلا", "طول", "طوطی", "ظرف", "ظهر", "عاج", "عادت", "عادل", "عاقل", "عکس", "عسل", "عصر", "عطر", "عقاب", "عقرب", "علم", "عمه", "عمیق", "عینک", "غار", "غرب", "غذا", "غزل", "غول", "غم", "فال", "فکر", "فلفل", "فنر", "فیل", "فیلم", "قاب", "قارچ", "قبر", "قدر", "قرض", "قرمز", "قشر", "قفل", "قفس", "قله", "قلم", "قند", "قهر", "قیمت", "کابل", "کادو", "کار", "کارد", "کارت", "کارمند", "کاسه", "کاش", "کاغذ", "کبوتر", "کتاب", "کتری", "کچل", "کدو", "کرج", "کرسی", "کره", "کف", "کفش", "کلاس", "کلید", "کمد", "کمک", "کود", "کودک", "کور", "کوه", "کیسه", "کیف", "کیل", "گاو", "گچ", "گدا", "گرد", "گردن", "گرگ", "گرم", "گروه", "گز", "گل", "گلیم", "گلو", "گندم", "گوش", "گوجه", "گیلاس", "لاب", "لب", "لبه", "لجباز", "لحاف", "لذت", "لرز", "لغت", "لک", "لکه", "لمس", "لنگ", "لوگو", "لوله", "لیز", "مات", "ماست", "ماشین", "ماه", "ماهی", "مبل", "متن", "مثل", "مجلس", "محل", "مخ", "مدرک", "مد", "مداد", "مرز", "مرغ", "مرگ", "مرکز", "مزه", "مزد", "مشت", "مصر", "مغز", "مفت", "ملخ", "ملکه", "من", "موج", "مور", "موش", "موز", "موم", "مه", "مهر", "مهلت", "مهم", "میخ", "میز", "میش", "میوه", "ناب", "ناز", "نام", "نان", "نرم", "نصف", "نفس", "نفت", "نقد", "نقش", "نمره", "نوع", "نور", "نوش", "نوک", "نیاز", "نیک", "نیم", "نی", "واگن", "وام", "وجه", "وزن", "وطن", "وقت", "هتل", "هدف", "هرم", "هلو", "هوا", "هویج", "هیچ", "یاد", "یار", "یاس", "یخ"],
        5: ["آبادان", "آبشار", "آبمیوه", "آجر", "آخرین", "آرامش", "آرزو", "آرمان", "آزمون", "آژانس", "آسان", "آسمان", "آسیاب", "آشپز", "آشنا", "آفتاب", "آلبوم", "آلمان", "آلوده", "آواره", "آواز", "آویز", "آینه", "ابریشم", "اتاق", "اتفاق", "اثر", "اجتماع", "اجرا", "اداره", "ادامه", "ادبیات", "اراده", "ارزان", "ارزش", "اسب", "اسباب", "اسپاگتی", "استاد", "استخر", "اسکی", "اسیر", "اشاره", "اشکال", "اصفهان", "اصل", "اصلی", "اعتماد", "اعزام", "افسوس", "افسر", "افکار", "اقامت", "اقلیم", "اکسیژن", "اکنون", "الماس", "النگو", "امتحان", "امروز", "امضا", "امکان", "امنیت", "امیدوار", "انتخاب", "انجام", "اندازه", "اندوه", "انسان", "انضباط", "انعام", "انقلاب", "انگیزه", "اهواز", "اول", "ایران", "ایراد", "ایستگاه", "ایمان", "اینجا", "بابونه", "بادام", "بادکنک", "باران", "باربر", "باریک", "بازار", "بازرس", "بازیگر", "باغبان", "بافت", "باقلا", "باکره", "بالا", "بالش", "بانک", "باهوش", "ببر", "بحران", "بخار", "بخاری", "بخش", "بخشنده", "بد", "بدبخت", "بدن", "بذر", "برادر", "برج", "برتر", "برخورد", "برده", "برنده", "برنز", "برنامه", "بزرگ", "بز", "بشقاب", "بغل", "بلال", "بلدرچین", "بلور", "بلیت", "بمب", "بنا", "بندر", "بنفش", "بنیاد", "بوی", "بهار", "بهتر", "بهشت", "بوفه", "بوقلمون", "بیمار", "بینا", "پادشاه", "پارچه", "پاسخ", "پاشنه", "پاکت", "پایان", "پاییز", "پدر", "پرچم", "پرده", "پرستار", "پرستو", "پرسش", "پروانه", "پرواز", "پزشک", "پسر", "پسته", "پل", "پلنگ", "پلیس", "پناه", "پنبه", "پنج", "پنجره", "پودر", "پونه", "پهلوان", "پیاده", "پیاز", "پیام", "پیچ", "پیچک", "پیر", "پیرزن", "پیرمرد", "پیره", "پیک", "پیکان", "پیمان", "تابستان", "تاریخ", "تاکسی", "تایر", "تجربه", "تحصیل", "تخت", "تخته", "تخفیف", "تخم", "تراش", "تربچه", "ترجمه", "ترس", "ترشی", "تلاش", "تلفن", "تماشا", "تمیز", "تنها", "تنور", "توپ", "توت", "توضیح", "توفان", "تپه", "تک", "تکلیف", "تکه", "تگرگ", "جایزه", "جشن", "جغد", "جلبک", "جمع", "جمعه", "جنگل", "جهان", "جهت", "جیب", "جیغ", "حباب", "حجاب", "حدس", "حرارت", "حراج", "حریر", "حساب", "حسود", "حقوق", "حلقه", "حمام", "حمله", "حیات", "حیوان", "خادم", "خارج", "خارپشت", "خازن", "خاطره", "خاک", "خال", "خامه", "خاموش", "خانه", "خانواده", "خبر", "خدمت", "خراب", "خرید", "خز", "خزنده", "خسیس", "خشک", "خط", "خطا", "خطر", "خلیج", "خلبان", "خمیر", "خواب", "خواهش", "خواننده", "خوب", "خود", "خودکار", "خون", "خیابان", "خیال", "خیمه", "دادگاه", "دارو", "داستان", "داغ", "دانش", "دبیر", "دختر", "در", "درخت", "درد", "درس", "درمان", "دروازه", "دریا", "دزد", "دست", "دسته", "دشمن", "دعا", "دفاع", "دفتر", "دکمه", "دکل", "دل", "دلیل", "دما", "دماغ", "دندان", "دنیا", "دنده", "دو", "دوات", "دوچرخه", "دود", "دور", "دوربین", "دوره", "دوست", "دوش", "دولت", "ده", "دهان", "دهکده", "دی", "دیوار", "دیگر", "ذغال", "ذرت", "ذوق", "رادیو", "راز", "راست", "راننده", "راه", "راهرو", "رخت", "رشد", "رشته", "رطوبت", "رفتار", "رقیب", "رم", "رمان", "رنگ", "رو", "روان", "رود", "روز", "روستا", "روشن", "روغن", "ریاضی", "ریشه", "زابل", "زانو", "زبان", "زنبور", "زنجیر", "زندان", "زنده", "زندگی", "زنگ", "زود", "زور", "زوزه", "زیبا", "زیر", "زیره", "زیتون", "ژاکت", "ژاله"],
        6: ["آرامگاه", "آرایشگر", "آزمایش", "آسایش", "آشپز", "آشغال", "آشنا", "آغاز", "آفتابه", "آلودگی", "آینده", "ابریشم", "اتوبوس", "اتومبیل", "اجازه", "اجتماع", "احترام", "احساس", "اخبار", "اخطار", "اداره", "ادامه", "ادبیات", "اردیبهشت", "ارسال", "ارکیده", "ارمنستان", "اروپا", "استخوان", "استراحت", "استکان", "اسفناج", "اسلحه", "اشتباه", "اصفهان", "اطراف", "اطلاع", "اعداد", "اعتقاد", "اعصاب", "اعماق", "افسانه", "افسر", "افغانستان", "افکار", "اقامت", "اقتصاد", "اقیانوس", "اکتبر", "اکسیژن", "الکتریک", "الماس", "النگو", "امارات", "امپراتور", "امتحان", "امداد", "امروز", "امضا", "امکان", "امنیت", "انتخاب", "انتظار", "انجام", "اندازه", "اندام", "اندیشه", "انسان", "انشا", "انضباط", "انعکاس", "انفجار", "انقلاب", "انگشت", "انگشتر", "انگلیس", "انگور", "اهواز", "ایرانی", "ایراد", "ایستگاه", "اینترنت", "بابونه", "بادام", "بادبادک", "بادمجان", "بارانی", "بارسلون", "بازارچه", "بازتاب", "بازدید", "بازیگر", "باغچه", "باغبان", "بافتنی", "باقلا", "بالگرد", "بامیه", "بانک", "بحران", "بخاری", "بخشنده", "بدبخت", "بدبین", "بدجنس", "بدشانس", "بدلیجات", "برادرزاده", "براده", "برتری", "برجسته", "برخورد", "بررسی", "برعکس", "برگزار", "برگشت", "برنامه", "برنده", "برهنه", "بزرگترین", "بزرگراه", "بستنی", "بسیار", "بشقاب", "بلدرچین", "بلندگو", "بنادر", "بنفش", "بنگاه", "بنیانگذار", "بورس", "بوسه", "بوفه", "بوقلمون", "بهترین", "بیابان", "بیان", "بیمار", "پادشاه", "پارکینگ", "پایتخت", "پاییز", "پدر", "پرتقال", "پرستار", "پروانه", "پرواز", "پروژه", "پزشک", "پسر", "پلنگ", "پلیس", "پناهگاه", "پنجره", "پنیر", "پوتین", "پودر", "پونه", "پهلوان", "پیاده", "پیاز", "پیام", "پیچک", "پیرزن", "پیرمرد", "پیکان", "پیمان", "تابستان", "تاریخ", "تاکسی", "تجربه", "تحصیل", "تخفیف", "تخم", "تراش", "تربچه", "ترجمه", "ترشی", "تصادف", "تصویر", "تفاوت", "تقویم", "تکلیف", "تکنیک", "تکرار", "تگرگ", "تلفن", "تلویزیون", "تماشا", "تمیز", "تنها", "تنور", "توپ", "توت", "توضیح", "تولید", "تپه", "تک", "تکه", "جایزه", "جشن", "جشنواره", "جغد", "جلبک", "جمعه", "جنگل", "جهان", "جهت", "حباب", "حجاب", "حرارت", "حراج", "حساب", "حقوق", "حلقه", "حمام", "حمله", "حیات", "حیوان", "خادم", "خارج", "خارپشت", "خاطره", "خال", "خامه", "خاموش", "خانواده", "خبر", "خدمت", "خراب", "خرید", "خزنده", "خسیس", "خشک", "خطا", "خطر", "خلیج", "خلبان", "خمیر", "خواهش", "خواننده", "خودکار", "خیابان", "خیال", "دادگاه", "دارو", "داستان", "دانش", "دبیر", "دختر", "درخت", "درمان", "دروازه", "دریا", "دسته", "دشمن", "دفاع", "دفتر", "دکمه", "دلیل", "دما", "دماغ", "دندان", "دنیا", "دنده", "دوچرخه", "دوربین", "دوره", "دوست", "دولت", "دهان", "دهکده", "دیوار", "دیگر", "ذغال", "ذرت", "رادیو", "راز", "راست", "راننده", "راهرو", "رشد", "رشته", "رطوبت", "رفتار", "رقیب", "رمان", "روان", "رود", "روز", "روستا", "روشن", "روغن", "ریاضی", "ریشه", "زانو", "زبان", "زنبور", "زنجیر", "زندان", "زنده", "زندگی", "زنگ", "زود", "زور", "زوزه", "زیبا", "زیر", "زیره", "زیتون", "ژاکت", "ژاله"]
    };

    // --- انتخاب عناصر ---
    const gridContainer = document.getElementById('grid-container');
    const keyboardContainer = document.getElementById('keyboard-container');
    const difficultySelector = document.getElementById('difficulty-selector');
    const toast = document.getElementById('toast');

    // --- وضعیت بازی ---
    let wordLength = 5;
    let secretWord = '';
    let currentRow = 0;
    let currentCol = 0;
    let isProcessing = false; // برای جلوگیری از ورودی‌های تکراری هنگام پردازش
    let guesses = [];
    
    // --- تعریف کیبورد ---
    const keys = [
        ["ض", "ص", "ث", "ق", "ف", "غ", "ع", "ه", "خ", "ح", "ج"],
        ["چ", "ش", "س", "ی", "ب", "ل", "ا", "ت", "ن", "م", "ک"],
        ["گ", "ظ", "ط", "ز", "ر", "ذ", "د", "پ", "و", "ENTER"],
        ["ژ", "Backspace"]
    ];

    const normalizeWord = (word) => {
        if (!word) return '';
        return word
            .trim()
            .replace(/آ/g, 'ا')
            .replace(/ي|ئ/g, 'ی')
            .replace(/ك/g, 'ک');
    };

    const startGame = () => {
        gridContainer.innerHTML = '';
        keyboardContainer.innerHTML = '';
        currentRow = 0;
        currentCol = 0;
        isProcessing = false;
        guesses = Array(6).fill(null).map(() => Array(wordLength).fill(''));
        
        const wordList = WORD_BANK[wordLength];
        secretWord = normalizeWord(wordList[Math.floor(Math.random() * wordList.length)]);
        console.log("کلمه رمز (برای تست):", secretWord);

        for (let i = 0; i < 6; i++) {
            const row = document.createElement('div');
            row.className = 'grid-row';
            row.style.gridTemplateColumns = `repeat(${wordLength}, 1fr)`;
            for (let j = 0; j < wordLength; j++) {
                const tile = document.createElement('div');
                tile.className = 'grid-tile';
                tile.innerHTML = `<div class="front"></div><div class="back"></div>`;
                row.appendChild(tile);
            }
            gridContainer.appendChild(row);
        }

        keys.forEach(rowKeys => {
            const row = document.createElement('div');
            row.className = 'keyboard-row';
            rowKeys.forEach(key => {
                const button = document.createElement('button');
                button.className = 'key';
                button.textContent = key;
                if (key.length > 1) button.classList.add('large');
                button.addEventListener('click', () => handleKeyPress(key));
                row.appendChild(button);
            });
            keyboardContainer.appendChild(row);
        });
    };

    const handleKeyPress = (key) => {
        if (isProcessing) return;

        if (key === 'ENTER') {
            if (currentCol === wordLength) {
                submitGuess();
            }
            return;
        }
        if (key === 'Backspace') {
            if (currentCol > 0) {
                currentCol--;
                const tile = gridContainer.children[currentRow].children[currentCol];
                tile.querySelector('.front').textContent = '';
                tile.classList.remove('filled');
            }
            return;
        }
        if (currentCol < wordLength) {
            const tile = gridContainer.children[currentRow].children[currentCol];
            tile.querySelector('.front').textContent = key;
            tile.classList.add('filled');
            guesses[currentRow][currentCol] = key;
            currentCol++;
        }
    };
    
    const submitGuess = () => {
        isProcessing = true;
        const guess = normalizeWord(guesses[currentRow].join(''));
        const normalizedBank = WORD_BANK[wordLength].map(normalizeWord);

        if (!normalizedBank.includes(guess)) {
            showToast("کلمه در لیست نیست!");
            isProcessing = false;
            return;
        }

        const tiles = gridContainer.children[currentRow].children;
        const feedback = checkGuess(guess);
        let flipDelay = 0;

        for (let i = 0; i < wordLength; i++) {
            setTimeout(() => {
                tiles[i].classList.add('flip');
                tiles[i].querySelector('.back').textContent = tiles[i].querySelector('.front').textContent;
                tiles[i].classList.add(feedback[i]);
            }, flipDelay);
            flipDelay += 300;
        }
        
        setTimeout(() => {
            updateKeyboard(guess, feedback);
            if (guess === secretWord) {
                showToast("عالی بود! برنده شدی!");
                isProcessing = true; // بازی تمام شده، ورودی جدید نپذیر
            } else {
                currentRow++;
                currentCol = 0;
                if (currentRow === 6) {
                    showToast(`باختی! کلمه صحیح: ${secretWord}`);
                    isProcessing = true; // بازی تمام شده
                } else {
                    isProcessing = false; // آماده برای ردیف بعدی
                }
            }
        }, flipDelay);
    };
    
    const checkGuess = (guess) => {
        const feedback = Array(wordLength).fill('absent');
        const secretWordChars = secretWord.split('');
        const guessChars = guess.split('');
        
        for (let i = 0; i < wordLength; i++) {
            if (guessChars[i] === secretWordChars[i]) {
                feedback[i] = 'correct';
                secretWordChars[i] = null;
            }
        }
        
        for (let i = 0; i < wordLength; i++) {
            if (feedback[i] !== 'correct') {
                const charIndex = secretWordChars.indexOf(guessChars[i]);
                if (charIndex > -1) {
                    feedback[i] = 'present';
                    secretWordChars[charIndex] = null;
                }
            }
        }
        return feedback;
    };
    
    const updateKeyboard = (guess, feedback) => {
        for (let i = 0; i < guess.length; i++) {
            const keyElement = [...document.querySelectorAll('.key')].find(k => k.textContent === guess[i]);
            if (!keyElement) continue;

            const currentStatus = keyElement.classList;
            const newStatus = feedback[i];

            if (currentStatus.contains('correct')) continue;
            if (currentStatus.contains('present') && newStatus !== 'correct') continue;
            
            keyElement.classList.remove('present', 'absent');
            keyElement.classList.add(newStatus);
        }
    };

    const showToast = (message) => {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    };

    difficultySelector.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        
        wordLength = parseInt(e.target.dataset.length);
        document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        startGame();
    });

    // Handle physical keyboard input
    document.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        if (key === 'enter') {
            handleKeyPress('ENTER');
        } else if (key === 'backspace') {
            handleKeyPress('Backspace');
        } else if (/^[a-zضصثقفغعهخحجچشسیبلاتنمکگظطزرذدپوژ]$/.test(key)) { // Support Persian keys
            handleKeyPress(key);
        }
    });

    startGame();
});
            
